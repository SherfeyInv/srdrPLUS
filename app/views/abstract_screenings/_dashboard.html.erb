<div class="px-4 sm:px-6 lg:px-8 pt-8" x-data="$store.dashboard">
  <div>
    <h3 class="text-xl leading-6 font-medium text-gray-900">
      Citation Processing Pipeline (I - V)
    </h3>
    <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-5">
      <div class="px-4 py-5 bg-white shadow rounded-lg overflow-hidden sm:p-6">
        <dt class="text-sm font-medium text-gray-500 truncate">
          I. Citation Pool
        </dt>
        <dd
          class="mt-1 text-3xl font-semibold text-gray-900"
          x-text="$store.dashboard.kpis.up"
          :class="$store.dashboard.show.up ? '' : 'invisible'"
          x-transition
        >
          ..
        </dd>
      </div>

      <div class="px-4 py-5 bg-white shadow rounded-lg overflow-hidden sm:p-6">
        <dt class="text-sm font-medium text-gray-500 truncate">
          II. In Abstract Screening
        </dt>
        <dd class="mt-1 text-3xl font-semibold text-gray-900">
          <span
            x-text="$store.dashboard.kpis.as"
            :class="$store.dashboard.show.as ? '' : 'invisible'"
            x-transition
            >..
          </span>
          /
          <span
            x-text="$store.dashboard.kpis.asr"
            :class="$store.dashboard.show.asr ? '' : 'invisible'"
            x-transition
            >..</span
          >
          <span class="text-xs font-extralight text-gray-500"
            >(active / rejected)</span
          >
        </dd>
      </div>

      <div class="px-4 py-5 bg-white shadow rounded-lg overflow-hidden sm:p-6">
        <dt class="text-sm font-medium text-gray-500 truncate">
          III. In Full Text Screening
        </dt>
        <dd class="mt-1 text-3xl font-semibold text-gray-900">
          <span
            x-text="$store.dashboard.kpis.fs"
            :class="$store.dashboard.show.fs ? '' : 'invisible'"
            x-transition
            >..
          </span>
          /
          <span
            x-text="$store.dashboard.kpis.fsr"
            :class="$store.dashboard.show.fsr ? '' : 'invisible'"
            x-transition
            >..</span
          >
          <span class="text-xs font-extralight text-gray-500"
            >(active / rejected)</span
          >
        </dd>
      </div>

      <div class="px-4 py-5 bg-white shadow rounded-lg overflow-hidden sm:p-6">
        <dt class="text-sm font-medium text-gray-500 truncate">
          IV. In Data Extraction
        </dt>
        <dd
          class="mt-1 text-3xl font-semibold text-gray-900"
          x-text="$store.dashboard.kpis.de"
          :class="$store.dashboard.show.de ? '' : 'invisible'"
          x-transition
        >
          ..
        </dd>
      </div>

      <div class="px-4 py-5 bg-white shadow rounded-lg overflow-hidden sm:p-6">
        <dt class="text-sm font-medium text-gray-500 truncate">V. Completed</dt>
        <dd
          class="mt-1 text-3xl font-semibold text-gray-900"
          x-text="$store.dashboard.kpis.c"
          :class="$store.dashboard.show.c ? '' : 'invisible'"
          x-transition
        >
          ..
        </dd>
      </div>
    </dl>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.store("dashboard", {
      kpis: {
        up: "..",
        as: "..",
        asr: "..",
        fs: "..",
        fsr: "..",
        de: "..",
        c: "..",
      },

      show: {
        up: true,
        as: true,
        asr: true,
        fs: true,
        fsr: true,
        de: true,
        c: true,
      },

      init() {
        this.fetch_kpis();
      },

      async fetch_kpis() {
        const response = await fetch("/projects/<%= @project.id %>/kpis", {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
        });
        this.kpis = await response.json();
      },
    });
  });

  document.addEventListener("alpine:initialized", () => {
    Object.keys(Alpine.store("dashboard").kpis).forEach(function (key) {
      Alpine.store("dashboard").$watch("kpis." + key, (a, b) => {
        if (a != b) {
          Alpine.store("dashboard").show[key] = false;
          setTimeout(() => {
            Alpine.store("dashboard").show[key] = true;
          }, 300);
        }
      });
    });
  });
</script>
